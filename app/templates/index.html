<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Платный сыр</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style17.css') }}">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <div id="model-container"></div>

    <div class="content">
        <div class="raffle-info">
        </div>
        <h2 class="raffle-name">{{ settings['name'] }}</h2> <!-- Название розыгрыша -->
        <h1 id="username"></h1>
        <p id="statusMessage"></p>

        {% if settings['remaining_tickets'] > 0 %}
            <div><button id="buyButton">{{ settings['tickets_price'] }} TON</button></div>
            <div><button id="checkPaymentButton" class="secondary-button">Проверить</button></div>
        {% else %}
            <p id="statusMessage">Сыр закончился</p>
        {% endif %}
    </div>

    <p class="raffle-tickets">{{ settings['remaining_tickets'] }} / {{ settings['tickets_count'] }}</p>
    <div class="progress-bar-container">
        <div class="progress-bar">
            <div class="progress" style="width: {{ (settings['remaining_tickets'] / settings['tickets_count']) * 100 }}%;"></div>
        </div>
    </div>

    <p class="raffle-date">{{ settings['date'] }}</p>

    <div id="log-container"></div>

    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>

    <script>
        function logToScreen(message) {
            console.log(message);
            const logContainer = document.getElementById('log-container');
            logContainer.textContent += message + '\n';
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        logToScreen('Script started');

        const tg = window.Telegram.WebApp;
        tg.setHeaderColor("#000000");
        tg.expand();

        const usernameElement = document.getElementById('username');
        const statusMessage = document.getElementById('statusMessage');
        const buyButton = document.getElementById('buyButton');
        const checkPaymentButton = document.getElementById('checkPaymentButton');

        if (tg.initDataUnsafe.user) {
            const user = tg.initDataUnsafe.user;
            const userId = user.id;
            const username = user.username ? `@${user.username}` : '';

            logToScreen('Fetching status for user: ' + username);

            fetch(`/check_status/${userId}?username=${encodeURIComponent(username)}`)
                .then(response => response.json())
                .then(data => {
                    logToScreen('Status: ' + data.status);
                    if (data.status === 'suc') {
                        if (buyButton) buyButton.style.display = 'none';
                        if (checkPaymentButton) checkPaymentButton.style.display = 'none';
                        statusMessage.textContent = 'Вы участвуете!';

                        const fullText = `Welcome, ${user.username || user.first_name}!`;

                        usernameElement.innerHTML = '';
                        for (let i = 0; i < fullText.length; i++) {
                            const span = document.createElement('span');
                            span.textContent = fullText[i];
                            span.style.setProperty('--i', i);
                            usernameElement.appendChild(span);
                        }
                        usernameElement.classList.add('bounce-text');
                    } else if (data.status === 'no_tickets') {
                        statusMessage.textContent = 'Сыр закончился';
                    } else {
                        usernameElement.textContent = `Welcome, ${user.username || user.first_name}!`;

                        if (buyButton) {
                            buyButton.addEventListener('click', () => {
                                logToScreen('Buy button clicked.');
                                if (data.invoice_url) {
                                    logToScreen('Redirecting to invoice: ' + data.invoice_url);
                                    window.location.href = data.invoice_url;
                                } else {
                                    logToScreen('No invoice URL, reloading page.');
                                    window.location.reload();
                                }
                            });
                        }

                        if (checkPaymentButton) {
                            checkPaymentButton.addEventListener('click', () => {
                                logToScreen('Checking payment status...');
                                fetch(`/check_payment/${userId}`, {
                                    method: 'POST'
                                })
                                .then(response => response.json())
                                .then(data => {
                                    logToScreen('Payment check response: ' + JSON.stringify(data));
                                    if (data.status === 'suc') {
                                        statusMessage.textContent = 'Оплачено! Страница обновляется...';
                                        setTimeout(() => {
                                            window.location.reload();
                                        }, 2000);
                                    } else if (data.status === 'not_paid') {
                                        statusMessage.textContent = 'Не оплачено';
                                    }
                                })
                                .catch(error => {
                                    logToScreen('Error checking payment: ' + error);
                                });
                            });
                        }
                    }
                })
                .catch(error => {
                    logToScreen('Error fetching status: ' + error);
                    statusMessage.textContent = 'Сыр закончился';
                });
        }

        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);

        const renderer = new THREE.WebGLRenderer();
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.getElementById('model-container').appendChild(renderer.domElement);

        const controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.25;
        controls.enableZoom = true;
        controls.enablePan = true;
        controls.minPolarAngle = Math.PI / 2;
        controls.maxPolarAngle = Math.PI / 2;

        let model;
        const loader = new THREE.GLTFLoader();
        loader.load('{{ url_for('static', filename='model.glb') }}', function (gltf) {
            model = gltf.scene;
            scene.add(model);
            model.position.y += 1;
            camera.position.z = 5;
            camera.position.y = 1;
        }, undefined, function (error) {
            logToScreen('Error loading model: ' + error);
        });

        function animate() {
            requestAnimationFrame(animate);
            if (model) {
                model.rotation.y += 0.01;
            }
            controls.update();
            renderer.render(scene, camera);
        }
        animate();
    </script>
</body>
</html>
